#!/bin/bash

#
# Dynamically generated by Chef on <%= node["fqdn"] %>
# Local modifications will be overwritten by Chef.
#

<% if node["auto-patch"]["prep"]["splay"] > 0 -%>
sleep $[ ( $RANDOM % <%= node["auto-patch"]["prep"]["splay"] %> )  + 1 ]s
<% end -%>

<% if node["auto-patch"]["prep"]["clean"] -%>
<% case node["platform_family"] -%>
<% when "rhel" -%>
( /usr/bin/yum -e 0 -d 0 clean all > /dev/null ) 2>&1 | grep -v \
  -e "Unable to read consumer identity"
<% else -%>
/usr/bin/apt-get -q=2 clean > /dev/null
<% end -%>
<% end -%>

<% case node["platform_family"] -%>
<% when "rhel" -%>
( /usr/bin/yum -y -e 0 -d 0 --downloadonly update > /dev/null ) 2>&1 | grep -v \
  -e "Unable to read consumer identity" \
  -e "Repository '.*' is missing name in configuration, using id" \
  -e "exiting because --downloadonly specified" \
  -e "^\s*$"
<% else -%>
/usr/bin/apt-get -q=2 update > /dev/null
/usr/bin/apt-get -q=2 --downloadonly upgrade > /dev/null
<% end -%>

<% if node["auto-patch"]["prep"]["update_updater"] -%>
<% case node["platform_family"] -%>
<% when "rhel" -%>
( /usr/bin/yum -y -e 0 -d 0 update yum > /dev/null ) 2>&1 | grep -v \
  -e "Unable to read consumer identity"
<% else -%>
/usr/bin/apt-get -q=2 upgrade apt > /dev/null
<% end -%>
<% end -%>
