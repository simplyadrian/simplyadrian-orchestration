#!/bin/bash

# Script to repair C*

#Variables
day=$(date +"%u")                              #Day of week. 1 = Monday
bodyfile="$script/repair.txt"
script="/tmp/script"

errsubject="Repair Error on $HOSTNAME"
sucesssubject="Repair Completed on $HOSTNAME"
email="root.linux@simplyadrian.com"


# Start repairs
echo -e "Repair Script Started: $(date)\n" > $bodyfile
if [ "$HOSTNAME" == "pchdsl-cass101" ] || [ "$HOSTNAME" == "pchdsl-cass106" ] || [ "$HOSTNAME" == "pchdsl-cass112" ] || [ "$HOSTNAME" == "pchdsl-cass115" ] || [ "$HOSTNAME" == "pchdsl-cass119" ] || [ "$HOSTNAME" == "pchdsl-cass130" ] && [ "$day" == "1" ]; then
		# Create Script folder
		mkdir $script
        # Execute Repairs
		nodetool repair Mobile Device DeviceActivityHistory DeviceIncentiveHistory DeviceUDID DeviceUDID_IDX_DeviceId OfferConversionDayAggregate OfferConversionHourAggregate OfferConversionMonthAggregate OfferConversionUnaggregated PaymentReceipt -pr >> $bodyfile 2>&1
        retval=$?
        echo -e "Repair Command finished: $(date)\n" >> $bodyfile
elif [ "$HOSTNAME" == "pchdsl-cass104" ] || [ "$HOSTNAME" == "pchdsl-cass108" ] || [ "$HOSTNAME" == "pchdsl-cass118" ] || [ "$HOSTNAME" == "pchdsl-cass121" ] || [ "$HOSTNAME" == "pchdsl-cass125" ] || [ "$HOSTNAME" == "pchdsl-cass127" ] && [ "$day" == "2" ]; then
		# Create Script folder
		mkdir $script
        # Execute Repairs
		nodetool repair Mobile Device DeviceActivityHistory DeviceIncentiveHistory DeviceUDID DeviceUDID_IDX_DeviceId OfferConversionDayAggregate OfferConversionHourAggregate OfferConversionMonthAggregate OfferConversionUnaggregated PaymentReceipt -pr >> $bodyfile 2>&1
        retval=$?
        echo -e "Repair Command finished: $(date)\n" >> $bodyfile
elif [ "$HOSTNAME" == "pchdsl-cass102" ] || [ "$HOSTNAME" == "pchdsl-cass109" ] || [ "$HOSTNAME" == "pchdsl-cass113" ] || [ "$HOSTNAME" == "pchdsl-cass120" ] || [ "$HOSTNAME" == "pchdsl-cass123" ] || [ "$HOSTNAME" == "pchdsl-cass126" ] && [ "$day" == "3" ]; then
		# Create Script folder
		mkdir $script
        # Execute Repairs
		nodetool repair Mobile Device DeviceActivityHistory DeviceIncentiveHistory DeviceUDID DeviceUDID_IDX_DeviceId OfferConversionDayAggregate OfferConversionHourAggregate OfferConversionMonthAggregate OfferConversionUnaggregated PaymentReceipt -pr >> $bodyfile 2>&1
        retval=$?
        echo -e "Repair Command finished: $(date)\n" >> $bodyfile
elif [ "$HOSTNAME" == "pchdsl-cass105" ] || [ "$HOSTNAME" == "pchdsl-cass107" ] || [ "$HOSTNAME" == "pchdsl-cass114" ] || [ "$HOSTNAME" == "pchdsl-cass116" ] || [ "$HOSTNAME" == "pchdsl-cass122" ] || [ "$HOSTNAME" == "pchdsl-cass128" ] && [ "$day" == "4" ]; then
		# Create Script folder
		mkdir $script
        # Execute Repairs
        nodetool repair Mobile Device DeviceActivityHistory DeviceIncentiveHistory DeviceUDID DeviceUDID_IDX_DeviceId OfferConversionDayAggregate OfferConversionHourAggregate OfferConversionMonthAggregate OfferConversionUnaggregated PaymentReceipt -pr >> $bodyfile 2>&1
        retval=$?
        echo -e "Repair Command finished: $(date)\n" >> $bodyfile
elif [ "$HOSTNAME" == "pchdsl-cass103" ] || [ "$HOSTNAME" == "pchdsl-cass110" ] || [ "$HOSTNAME" == "pchdsl-cass111" ] || [ "$HOSTNAME" == "pchdsl-cass117" ] || [ "$HOSTNAME" == "pchdsl-cass124" ] || [ "$HOSTNAME" == "pchdsl-cass129" ] && [ "$day" == "5" ]; then
		# Create Script folder
		mkdir $script
        # Execute Repairs
		nodetool repair Mobile Device DeviceActivityHistory DeviceIncentiveHistory DeviceUDID DeviceUDID_IDX_DeviceId OfferConversionDayAggregate OfferConversionHourAggregate OfferConversionMonthAggregate OfferConversionUnaggregated PaymentReceipt -pr >> $bodyfile 2>&1
        retval=$?
        echo -e "Repair Command finished: $(date)\n" >> $bodyfile
else
		exit 1;
fi

# Send Email
if [ $retval -ne 0 ]; then
        echo -e "Repair finished with an error.\n" >> $bodyfile
        /bin/mail -s "$errsubject" "$email" < $bodyfile
		rm -rf $script
        exit 1;
elif [ $retval -eq 0 ]; then
        echo -e "\nRepair Completed Successfully on$(date) \n" >> $bodyfile
        /bin/mail -s "$sucesssubject" "$email" < $bodyfile
fi


# Clean up tmp drop script.
rm -rf $script

exit 0;
